<button mat-raised-button color="primary" (click)="openNewPostDialog()">
	<mat-icon fontIcon="edit"></mat-icon>
	New Post
</button>

<div id="post-container">
	@if (posts() && posts()!.length > 0) { @for (post of posts(); track post.id)
	{
	<div class="post">
		<div class="post-main">
			<div class="post-header">
				@let fromOther = post.author.id !== post.host.id; @let template
				= mode === 'feed' ? forFeed : forWall;

				<ng-container
					*ngTemplateOutlet="template; context: { post, fromOther }"
				></ng-container>

				<span class="post-time">{{ post.createdAt | humanTime }}&nbsp;</span>

				<mat-icon [class.pulsing]="pulsingLikeId() === post.id" [fontIcon]="post.userLikesIt ? 'favorite' : 'favorite_border'" style="margin-left: auto; cursor: pointer; color: var(--mat-sys-primary);" (click)="likePost(post.id, post.userLikesIt)"></mat-icon>
			</div>

			@if (post.content) {
				<div class="post-content" [innerHTML]="(post.content | linkify)"></div>
			}

			@if (post.imagePresent === true) {
				<img [src]="'/content/post-images/' + post.id + '.jpg' + imgQuery()" alt="Post image" style="margin: 0 -1rem; margin-bottom: -1rem;"/>
			}
		</div>

		<div class="comment-pane-toggle" (click)="post.commentsExpanded = !post.commentsExpanded" [class.collapsed]="!post.commentsExpanded">
			Comments
			@if (post.comments && post.comments.length > 0) {
				({{ post.comments.length }})
			}

			@if (post.commentsExpanded) {
				<mat-icon fontIcon="keyboard_arrow_up"></mat-icon>
			} @else {
				<mat-icon fontIcon="keyboard_arrow_down"></mat-icon>
			}
		</div>

		@if (post.commentsExpanded) {
			<div class="comment-pane">
				<input
					class="new-comment-input"
					#newCommentInput
					type="text"
					name="add-comment"
					placeholder="Add a comment..."
					autocomplete="off"
					(keydown.enter)="addComment(newCommentInput.value, post.id); newCommentInput.value = ''"
				/>
	
				@if (post.comments) {
					@for (comment of post.comments; track comment.id) {
						<div class="comment">
							<div class="comment-meta">
								<img [src]="'/content/avatars/' + comment.author.id + '.jpg'" style="border-radius: 50%; height: 20px; width: 20px;"/>
	
								<a [routerLink]="['/user', comment.author.id]">
									{{ comment.author.username || 'Unknown' }}
								</a>
							</div>

							<div class="comment-content" [innerHTML]="(comment.content | linkify) || 'No content'"></div>
			
							<span class="time">{{ comment.createdAt | humanTime }}</span>
						</div>
					}
				}
			</div>
		}
	</div>
	} } @else {
	<div>No posts found.</div>
	}
</div>

<ng-template #forFeed let-post="post" let-fromOther="fromOther">
	@if (fromOther) {
		<img [src]="'/content/avatars/' + post.author.id + '.jpg'" style="border-radius: 50%; height: 20px; width: 20px;"/>
		<a [routerLink]="['/user', post.author.id]">
			{{ post.author.username || 'Unknown' }}
		</a>&gt;
	}

	<img [src]="'/content/avatars/' + post.host.id + '.jpg'" style="border-radius: 50%; height: 20px; width: 20px;"/>

	<a [routerLink]="['/user', post.host.id]">
		{{ post.host.username || 'Unknown' }}
	</a>
</ng-template>

<ng-template #forWall let-post="post">
	<img [src]="'/content/avatars/' + post.author.id + '.jpg'" style="border-radius: 50%; height: 20px; width: 20px;"/>
		<a [routerLink]="['/user', post.author.id]">
			{{ post.author.username || 'Unknown' }}
		</a>
</ng-template>
